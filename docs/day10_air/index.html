<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Flight of the Rosefinch</title>
<link href="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  body { margin: 0; padding: 0; }
  #map { width: 100vw; height: 100vh; }



</style>
</head>
<body>

<div id="map"></div>
<div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); 
            display:flex; gap:10px; align-items:center; z-index:9999;">

    <div id="timestamp" style="
        padding: 8px 14px;
        background: #E9021F;
        color: white;
        font-family: Arial;
        font-size: 14px;
        border-radius: 6px;
    "></div>

    <button id="playPauseBtn" style="
        background: rgba(255, 255, 255, 0.85);
        border: none;
        padding: 4px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-family: Arial;
    ">⏸ Pause</button>

</div>
<div style="position:absolute; z-index:9999; left:20px; top: 20px;; 
            font-family:Arial; background:rgba(255,255,255,0.85); 
            padding:8px; max-width: 450px; max-height: 100px; border-radius:6px; display:flex; gap:10px; align-items:flex-start;">

    <div id="rosefinch-image" style="flex-shrink:0;">
        <img src="https://cdn.download.ams.birds.cornell.edu/api/v1/asset/169288651/2400" 
             alt="Rosefinch image, courtesy eBird, Will Morris" 
             style="width:120px; height:100%; border-radius:4px;">
    </div>

    <div style="flex:1;">
        <h2 style="margin:0; font-size:22px;">
            Flight of the Rosefinch
        </h2>

        <span style="font-size:14px; font-weight:normal; line-height:1.2; display:block; margin-top: 6px;">
            Seasonal migrations of the Common Rosefinch 
            <span style="font-style: italic;">(Carpodacus erythrinus)</span>, 2011–2016
        </span>
        <span style="font-size:14px; font-weight:normal; line-height: 0.9;">
            <a href="https://ebird.org/species/comros" style="color:red;">Learn more and hear its song at eBird</a>
        </span>
    </div>
</div>
<span style="position:absolute; z-index:9999; left:20px; bottom:10px; font-family:Arial; 
background:rgba(255,255,255,0.85); padding:8px; max-width: 400px;border-radius: 6px; font-size: 10px; margin-bottom: 10px;">
<span style="font-size: 12px;">By @jaanekaraster for 30 Day Map Challenge 2025, Day 10: Air</span>
<br>    
<span>Source: <a href="https://datarepository.movebank.org/entities/datapackage/7cf55ae8-94f6-4c87-a98b-af98366682b8" style="color:red">Movebank.org</a>: Lisovski S, Neumann R, Albrecht T, Munclinger P, Ahola MP, Bauer S, Cepak J, Fransson T, Jakobsson S, Jaakkonen T, Metzger B, Piha M, Shurulinkov P, Stach R, Ström K, Velmala W, Briedis M. 2021. Data from: The Indo-European Flyway: opportunities and constraints reflected by common rosefinches breeding across Europe. Movebank Data Repository. <a href="https://doi.org/10.5441/001/1.034jj41h" style="color:red">DOI</a></span>
<br>
<span>Image Credits: Will Morris, eBird</span>    
</span>

</div>

<div id="legend" style="
  position: absolute;
  right: 20px;
  top: 20px;
  z-index: 9999;
  background: rgb(255, 255, 255);
  padding: 10px 14px;
  border-radius: 6px;
  font-family: Arial, sans-serif;
  color: rgb(0, 0, 0);
  font-size: 12px;
">
  <div style="font-size: 13px; font-weight: bold; margin-bottom: 6px;">
    Month
  </div>

  <div style="
    width: 180px;
    height: 12px;
    border-radius: 6px;
    background: linear-gradient(
      to right,
      rgb(0,190,255),        /* January – light blue */
      rgb(204, 88, 162),      /* April – transition */
      rgb(233,2,31),       /* July – hot pink */
      rgb(204, 88, 162),      /* October – transition */
      rgb(0,190,255)         /* December – light blue */
    );
    margin-bottom: 4px;
  "></div>

  <div style="display:flex; justify-content:space-between;">
      <span>Jan</span><span>Apr</span><span>Jul</span><span>Oct</span><span>Dec</span>
  </div>
</div>


<script src="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.js"></script>
<script>

// ──────────────────────────────────────────────
// COLOR FUNCTION: month -> between light-blue & hot-pink
function monthToColor(month) {
  const t = Math.abs(month - 7) / 6;
  const hotPink = [255, 28, 57];
  const lightBlue = [0, 190, 255];

  const r = lightBlue[0] + (hotPink[0] - lightBlue[0]) * (1 - t);
  const g = lightBlue[1] + (hotPink[1] - lightBlue[1]) * (1 - t);
  const b = lightBlue[2] + (hotPink[2] - lightBlue[2]) * (1 - t);

  return `rgb(${r|0},${g|0},${b|0})`;
}

// ──────────────────────────────────────────────
// LOAD DATA
fetch("rosefinch-tracks.csv")
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",");

    const idxLng = headers.indexOf("location-long");
    const idxLat = headers.indexOf("location-lat");
    const idxTimestamp = headers.indexOf("timestamp");
    const idxId = headers.indexOf("individual-local-identifier");

    let points = rows.slice(1).map(row => {
      const cols = row.split(",");
      const ts = new Date(cols[idxTimestamp].trim());
      return {
        id: cols[idxId].trim(),
        lng: parseFloat(cols[idxLng]),
        lat: parseFloat(cols[idxLat]),
        timestamp: ts,
        month: ts.getUTCMonth() + 1
      };
    }).filter(p => !isNaN(p.lng) && !isNaN(p.lat) && !isNaN(p.timestamp));

    points.sort((a,b) => a.timestamp - b.timestamp);

    const individuals = {};
    points.forEach(p => {
      if (!individuals[p.id]) individuals[p.id] = [];
      individuals[p.id].push(p);
    });

    const geojson = { type: "FeatureCollection", features: [] };

    initMap(geojson, individuals);
  });

// ──────────────────────────────────────────────
// INITIALIZE MAP
function initMap(geojson, individuals) {
  const map = new maplibregl.Map({
    container: "map",
    style: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
    center: [45.683399, 46.051501],
    zoom: 2.8
  });

  map.on("load", () => {
    // Normal migration lines for current bird
    map.addSource("migration", { type: "geojson", data: geojson });
    map.addLayer({
      id: "migration-line",
      type: "line",
      source: "migration",
      layout: { "line-cap": "round", "line-join": "round" },
      paint: { "line-width": 2, "line-opacity": 0.9, "line-color": ["get","color"] }
    });

    // Glow around current bird path
    map.addSource("activeSegment", { type: "geojson", data: { type:"FeatureCollection", features:[] } });
    map.addLayer({
      id: "activeSegment-glow",
      type: "line",
      source: "activeSegment",
      layout: { "line-cap": "round", "line-join": "round" },
      paint: { "line-width": 8, "line-color": "white", "line-blur":5, "line-opacity":0.3 }
    });

    // Current bird point
    map.addSource("activePoint", { type: "geojson", data: { type:"FeatureCollection", features:[] } });
    map.addLayer({
      id: "activePoint-circle",
      type: "circle",
      source: "activePoint",
      paint: { "circle-radius":5, "circle-color":"red","circle-stroke-width":1.5,"circle-stroke-color":"white" }
    });

    // Completed birds (faded, lines only)
    map.addSource("completedBirds", { type: "geojson", data: { type:"FeatureCollection", features:[] } });
    map.addLayer({
      id: "completed-lines",
      type: "line",
      source: "completedBirds",
      layout: { "line-cap": "round", "line-join": "round" },
      paint: { "line-width": 2, "line-opacity": 0.3, "line-color": ["get","color"] }
    });

    animateTracksSingleIndividual(geojson, individuals, map);
  });
}

// ──────────────────────────────────────────────
// ANIMATE ONE BIRD AT A TIME, FADED TRAILS FOR COMPLETED
function animateTracksSingleIndividual(geojson, individuals, map) {
  const timestampDiv = document.getElementById("timestamp");
  const playPauseBtn = document.getElementById("playPauseBtn");
  let isPaused = false;

  const individualIds = Object.keys(individuals);
  let currentIndividualIndex = 0;

  let completedFeatures = [];

  playPauseBtn.addEventListener("click", () => {
    isPaused = !isPaused;
    playPauseBtn.innerText = isPaused ? "▶ Play" : "⏸ Pause";
  });

  function animateIndividual(individualId, callback) {
    const points = individuals[individualId];
    if (!points || points.length === 0) return callback();

    geojson.features = [];
    const activePath = [[points[0].lng, points[0].lat]];

    map.getSource("migration").setData({ type:"FeatureCollection", features:geojson.features });
    map.getSource("activeSegment").setData({ type:"FeatureCollection", features:[{type:"Feature", geometry:{type:"LineString", coordinates:activePath}}] });
    map.getSource("activePoint").setData({ type:"FeatureCollection", features:[{type:"Feature", geometry:{type:"Point", coordinates:[points[0].lng, points[0].lat]}, properties:{active:true}}] });
    timestampDiv.innerText = points[0].timestamp.toISOString().split("T")[0];

    let i = 1;

    function animateSegment() {
      if (i >= points.length) {
        // Save segments with original color for completed faded lines
        for (let j = 1; j < points.length; j++) {
          completedFeatures.push({
            type:"Feature",
            geometry: { type:"LineString", coordinates: [[points[j-1].lng, points[j-1].lat],[points[j].lng, points[j].lat]] },
            properties: { color: monthToColor(points[j-1].month) }
          });
        }
        map.getSource("completedBirds").setData({ type:"FeatureCollection", features: completedFeatures });
        callback();
        return;
      }

      const prev = points[i-1];
      const next = points[i];
      const dx = next.lng - prev.lng;
      const dy = next.lat - prev.lat;
      const frames = Math.max(1, Math.ceil(Math.sqrt(dx*dx + dy*dy)*1));
      let frame = 0;

      const tempSegmentFeature = {
        type:"Feature",
        properties:{id:individualId,color:monthToColor(prev.month)},
        geometry:{type:"LineString", coordinates:[[prev.lng, prev.lat]]}
      };
      geojson.features.push(tempSegmentFeature);

      function animateFrame() {
        if (isPaused) return requestAnimationFrame(animateFrame);
        const t = frame / frames;
        const lng = prev.lng + (next.lng - prev.lng)*t;
        const lat = prev.lat + (next.lat - prev.lat)*t;

        tempSegmentFeature.geometry.coordinates.push([lng, lat]);
        map.getSource("migration").setData({ type:"FeatureCollection", features:geojson.features });

        activePath.push([lng, lat]);
        map.getSource("activeSegment").setData({ type:"FeatureCollection", features:[{type:"Feature", geometry:{type:"LineString", coordinates:activePath}}] });

        map.getSource("activePoint").setData({ type:"FeatureCollection", features:[{type:"Feature", geometry:{type:"Point", coordinates:[lng, lat]}, properties:{active:true}}] });

        timestampDiv.innerText = next.timestamp.toISOString().split("T")[0];

        frame++;
        if (frame <= frames) requestAnimationFrame(animateFrame);
        else { i++; animateSegment(); }
      }

      animateFrame();
    }

    animateSegment();
  }

  function nextIndividual() {
    if (currentIndividualIndex >= individualIds.length) return;
    const individualId = individualIds[currentIndividualIndex];
    currentIndividualIndex++;
    animateIndividual(individualId, nextIndividual);
  }

  nextIndividual();
}

</script>

</body>
</html>
